name: Deploy Notebooks to GH Pages
on:
  push:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Convert Notebooks to HTML
        run: |
          mkdir -p public
          
          # Convert notebooks while preserving directory structure
          for n in [0-9][0-9][0-9]_*/*.ipynb; do
            [ -e "$n" ] || continue
            
            # Get the directory name (e.g., "001_micrograd")
            dir=$(dirname "$n")
            
            # Create the corresponding directory in public/
            mkdir -p "public/$dir"
            
            # Convert notebook to HTML in the same directory structure
            echo "Converting $n to public/$dir/"
            jupyter nbconvert --to html --template lab --output-dir="public/$dir" "$n" || echo "Failed to convert $n"
            
            # Copy the _imgs folder if it exists
            if [ -d "$dir/_imgs" ]; then
              echo "Copying images from $dir/_imgs to public/$dir/_imgs"
              cp -r "$dir/_imgs" "public/$dir/"
            fi
            
            # Copy the _src folder if it exists (for 007_GPT)
            if [ -d "$dir/_src" ]; then
              echo "Copying source files from $dir/_src to public/$dir/_src"
              cp -r "$dir/_src" "public/$dir/"
            fi
          done

          # 1. Clean up (delete) the duplicate header template in notebooks & Inject the shared blog header script into every page
          find public -name "*.html" -not -name "index.html" -exec sed -i '/<header class="site-header">/,/<\/header>/d' {} +
          find public -name "*.html" -not -name "index.html" -exec sed -i 's|<body>|<body><script src="https://chizkidd.github.io/header-loader.js"></script>|' {} +

          # Debug: show what was created
          echo "=== Directory structure in public/ ==="
          find public -type f | head -20

          # Generate the index.html landing page
          cat > public/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Neural Networks: Zero to Hero</title>
              <style>
                  * {
                      margin: 0;
                      padding: 0;
                  }
                  
                  html, body {
                      height: 100%;
                  }
                  
                  body {
                      font-family: Helvetica, Arial, sans-serif;
                      font-size: 16px;
                      line-height: 1.5;
                      font-weight: 300;
                      background-color: #fdfdfd;
                      display: grid;
                      grid-template-rows: auto 1fr auto;
                      min-height: 100vh;
                  }
                  
                  h1, h2, h3, h4, h5, h6 {
                      font-size: 100%;
                      font-weight: 400;
                  }
                  
                  a {
                      color: #2a7ae2;
                      text-decoration: none;
                  }
                  
                  a:hover {
                      color: #000;
                      text-decoration: underline;
                  }
                  
                  a:visited {
                      color: #205caa;
                  }
                  
                  .wrap {
                      max-width: 800px;
                      padding: 0 30px;
                      margin: 0 auto;
                  }
                  
                  /* Site header */
                  .site-header {
                      border-top: 5px solid #333;
                      border-bottom: 1px solid #e8e8e8;
                      min-height: 56px;
                      background-color: white;
                  }
                  
                  .site-title {
                      display: block;
                      color: #333;
                      font-size: 26px;
                      letter-spacing: -1px;
                      float: left;
                      line-height: 56px;
                      position: relative;
                      z-index: 1;
                  }
                  
                  .site-title:hover,
                  .site-title:visited {
                      color: #333;
                  }
                  
                  /* Page content */
                  .page-content {
                      padding: 30px 0;
                      background-color: #fff;
                  }
                  
                  .header-matched-heading {
                      color: #333;
                      font-size: 26px;
                      letter-spacing: -1px;
                      font-weight: 400;
                      text-align: left;
                      line-height: 1.2;
                      margin-top: 20px;
                      margin-bottom: 20px;
                  }
                  
                  .section-heading {
                      color: #333;
                      font-size: 26px;
                      letter-spacing: -1px;
                      font-weight: 400;
                      text-align: left;
                      line-height: 1.2;
                      margin-bottom: 40px;
                      border-bottom: 1px solid #ddd;
                      padding-bottom: 0.5px;
                  }
                  
                  .home-nav-list {
                      padding-left: 20px;
                      margin-bottom: 30px;
                      list-style-type: disc;
                  }
                  
                  .home-nav-list li {
                      margin-bottom: 5.5px;
                  }
                  
                  .home-nav-list a {
                      font-size: 1.0em;
                      font-weight: 300;
                      color: #2a7ae2;
                  }
                  
                  .home-nav-list a:hover {
                      color: #000;
                      text-decoration: underline;
                  }
                  
                  /* Site footer */
                  .site-footer {
                      border-top: 1px solid #e8e8e8;
                      padding: 30px 0;
                  }
                  
                  .site-footer p {
                      font-size: 15px;
                      letter-spacing: -.3px;
                      color: #828282;
                      text-align: center;
                  }
                  
                  .site-footer a {
                      color: #2a7ae2;
                  }
                  
                  @media screen and (max-width: 600px) {
                      .wrap {
                          padding: 0 12px;
                      }
                  }
              </style>
          </head>
          <body>
              <script src="https://chizkidd.github.io/header-loader.js"></script>

              <div class="page-content">
                  <div class="wrap">
                      <h1 class="header-matched-heading">Karpathy - Neural Networks: Zero to Hero</h1>
                      
                      <div class="section">
                          <h2 class="section-heading">Lectures</h2>
                          <ul class="home-nav-list" id="lectures-notebooks"></ul>
                      </div>

                      <div class="section">
                          <h2 class="section-heading">Exercises</h2>
                          <ul class="home-nav-list" id="exercises-notebooks"></ul>
                      </div>
                  </div>
              </div>

              <footer class="site-footer">
                  <div class="wrap">
                      <p>
                          Course by <a href="https://karpathy.ai/" target="_blank">Andrej Karpathy</a>
                          â€¢ <a href="https://github.com/chizkidd/Karpathy-Neural-Networks-Zero-to-Hero" target="_blank">View Repository</a>
                      </p>
                  </div>
              </footer>

              <script>
                  const lecturesList = document.getElementById('lectures-notebooks');
                  const exercisesList = document.getElementById('exercises-notebooks');
                  
          HTMLEOF
          
          # Add notebook links with full paths (preserving directory structure)
          echo "        const notebooks = [" >> public/index.html
          for n in [0-9][0-9][0-9]_*/*.ipynb; do
            [ -e "$n" ] || continue
            dir=$(dirname "$n")
            file=$(basename "$n" .ipynb).html
            name=$(basename "$n" .ipynb)
            # Full path includes directory
            fullpath="$dir/$file"
            echo "            {file: '$fullpath', name: '$name', folder: '$dir'}," >> public/index.html
          done
          echo "        ];" >> public/index.html
          
          cat >> public/index.html << 'JSEOF'
          
          // Sort notebooks by folder, then by name
          notebooks.sort((a, b) => {
              if (a.folder !== b.folder) return a.folder.localeCompare(b.folder);
              return a.name.localeCompare(b.name);
          });
          
          notebooks.forEach(nb => {
              const li = document.createElement('li');
              const a = document.createElement('a');
              a.href = nb.file;  // Now includes full path like "001_micrograd/micrograd.html"
              a.textContent = nb.name.replace(/_/g, ' ');
              li.appendChild(a);
              
              // Categorize: exercises vs lectures
              const isExercise = nb.name.toLowerCase().includes('exercise') || 
                                nb.name.toLowerCase().startsWith('ex');
              
              if (isExercise) {
                  exercisesList.appendChild(li);
              } else {
                  lecturesList.appendChild(li);
              }
          });
              </script>
          </body>
          </html>
          JSEOF

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'public'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4